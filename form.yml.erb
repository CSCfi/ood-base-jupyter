<% require "/ood/deps/util/attributes/csc_smart_attributes" -%>

# Batch Connect app configuration file
#
# @note Used to define the submitted cluster, title, description, and
#   hard-coded/user-defined attributes that make up this Batch Connect app.
---

# **MUST** set cluster id here that matches cluster configuration file located
# under /etc/ood/config/clusters.d/*.yml
# @example Use the Owens cluster at Ohio Supercomputer Center
#     cluster: "owens"
cluster: "puhti"

# Define attribute values that aren't meant to be modified by the user within
# the Dashboard form
attributes:
  # Set the corresponding modules that need to be loaded for Jupyter to run
  #
  # @note It is called within the batch job as `module load <modules>` if
  #   defined
  # @example Do not load any modules
  #     modules: ""
  # @example Using default python module
  #     modules: "python"
  # @example Using specific python module
  #     modules: "python/3.5"
  # @example Using combination of modules
  #     modules: "python/3.5 cuda/8.0.44"
  #modules: "python-env/2019.3"
  #bc_queue: "test" 

  # Any extra command line arguments to feed to the `jupyter notebook ...`
  # command that launches the Jupyter notebook within the batch job

  csc_slurm_partition:
    value: "interactive"
    select:
      - "interactive"
      - "small"
      - "gpu"
      - "gputest"
      - "test"
      - "fmi"
      - "fmitest"
    help: |
      Selecting a gpu partition will reserve 1 GPU (V100)
  csc_slurm_limits:
    data:
      limits:
        gpu:
          time: "8:00:00"
  python_module:
      label: Python
      widget: select
      options:
          - ["python-data"]
          - ["geoconda"]
          - ["python-env"]
          - ["pytorch"]
          - ["tensorflow"]
          - ["System"]
      help: |
        System python has no Jupyter installed, only custom environment using `venv` is supported.
  jp_type:
      widget: select
      label: "Jupyter type"
      options:
        - ["Notebook","notebook"]
        - ["Lab","lab"]
      value: "notebook"
      cacheable: false
      help: |
        `python-env`, `pytorch` and `tensorflow` only support Notebook
  notebook_dir:
    label: "Working directory"
    widget: select
    value: "/projappl"
    options:
      - "<%= ENV["HOME"] -%>"
      - "/projappl"
      - "/scratch"
      - "/"
  advanced:
    label: "Show advanced settings"
    widget: check_box
    value: "0"
  python_path:
    widget: text_field
    label: "PYTHONPATH"
    cacheable: false
    wrapper:
      class: "advanced env-vars"
  python_user_site:
    widget: check_box
    label: "Enable user packages"
    value: "0"
    wrapper:
      class: "advanced"
    help: |
      Enables using packages installed to the user packages directory. When disabled only virtual environment supports installing packages.
  enable_venv:
    widget: check_box
    label: "Use virtual environment"
    value: "1"
    wrapper:
      class: "advanced venv"
    help: |
      Create or use existing [virtual environment](https://docs.python.org/3/library/venv.html) based on selected module.
  venv:
    widget: text_field
    label: "Virtual environment path"
    value : ""
    wrapper:
      class: "advanced venv"
    help: |
      Path to a virtual environment under `/scratch` or `/projappl`. A new virtual environment will be created using `python -m venv <path>` it does not exist.
  venv_system_site_packages:
    widget: check_box
    label: "Enable --system-site-packages"
    value: "1"
    wrapper:
      class: "advanced venv"
    help: |
      Enables using site packages from the loaded module when creating a new virtual environment.
  extra_modules:
    widget: text_field
    label: "Extra modules"
    value : ""
    wrapper:
      class: "advanced"
    help: |
      Extra modules to load, separated by space. Load custom modules containing Python installations here.
  extra_jupyter_args:
    label: "Extra Jupyter args"
    value: ""
    wrapper:
      class: "advanced"

form:
  - csc_slurm_project
  - csc_slurm_partition
  - csc_header_resources
  - csc_cores
  - csc_memory
  - csc_nvme
  - csc_time
  - csc_header_settings
  - python_module
  - jp_type
  - notebook_dir
  - advanced
  - enable_venv
  - venv
  - python_user_site
  - extra_modules
  - extra_jupyter_args
  - csc_slurm_limits
